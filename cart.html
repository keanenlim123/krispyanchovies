<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krispy Anchovies</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const APIKEY = "678a60df19b96a25f2af6326";
            const API_URL = "https://krispyanchovies-33fe.restdb.io/rest/cart";

            // Fetch orders from RestDB
            function fetchOrders() {
                fetch(API_URL, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "x-apikey": APIKEY,
                        "Cache-Control": "no-cache"
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        const tableBody = document.getElementById("order-table-body");
                        const subtotalCell = document.getElementById("subtotal-value");
                        tableBody.innerHTML = ""; // Clear existing rows
                        let subtotal = 0; // Initialize subtotal

                        if (data.length === 0) {
                            tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No orders found</td></tr>`;
                            subtotalCell.textContent = "$0.00"; // Set subtotal to 0 if no orders
                            return;
                        }

                        data.forEach((order, index) => {
                            const row = document.createElement("tr");

                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${order.Name || "N/A"}</td>
                                <td>${order.Quantity || "0"}</td>
                                <td>$${order.Price || "0.00"}</td>
                                <td>$${order.Total_Price || "0.00"}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm delete-btn" data-id="${order._id}">Delete</button>
                                </td>
                            `;
                            tableBody.appendChild(row);

                            // Add the item's total price to the subtotal
                            subtotal += parseFloat(order.Total_Price) || 0;
                        });

                        // Display the updated subtotal
                        subtotalCell.textContent = `$${subtotal.toFixed(2)}`;

                        // Add event listeners for all delete buttons
                        const deleteButtons = document.querySelectorAll(".delete-btn");
                        deleteButtons.forEach(button => {
                            button.addEventListener("click", function () {
                                const id = this.getAttribute("data-id");
                                deleteOrder(id);
                            });
                        });
                    })
                    .catch(error => {
                        console.error("Error fetching orders:", error);
                        document.getElementById("order-table-body").innerHTML =
                            `<tr><td colspan="6" class="text-center text-danger">Failed to load data</td></tr>`;
                    });
            }

            // Delete order by ID
            function deleteOrder(id) {
                if (confirm("Are you sure you want to delete this order?")) {
                    fetch(`${API_URL}/${id}`, {
                        method: "DELETE",
                        headers: {
                            "Content-Type": "application/json",
                            "x-apikey": APIKEY,
                            "Cache-Control": "no-cache"
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                alert("Order deleted successfully!");
                                fetchOrders(); // Refresh the table
                            } else {
                                alert("Failed to delete the order.");
                            }
                        })
                        .catch(error => {
                            console.error("Error deleting order:", error);
                            alert("An error occurred while deleting the order.");
                        });
                }
            }
            // Initial fetch of orders
            fetchOrders();
        });
    </script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-white bg-white">
        <div class="container-fluid">
            <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav align-items-center">
                    <li class="nav-item ms-3">
                        <a class="nav-link" href="index.html" style="color:black; font-size: 18px;">Home</a>
                    </li>
                    <li class="nav-item ms-5">
                        <a class="nav-link" href="about_us.html" style="color:black; font-size: 18px;">About Us</a>
                    </li>
                    <li class="nav-item ms-5 d-flex align-items-center">
                        <img src="images/logo.png" alt="Logo" class="mx-auto" style="width: 80px;">
                    </li>
                    <li class="nav-item ms-5">
                        <a class="nav-link" href="products.html" style="color:black; font-size: 18px;">Products</a>
                    </li>
                    <li class="nav-item ms-5">
                        <a class="nav-link" href="rewards.html" style="color:black; font-size: 18px;">Rewards</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <hr>
    <div class="container mt-5">
        <h2 class="mb-4">View Orders</h2>
        <div class="table-wrapper my-5">
            <table class="table table-striped">
                <thead class="table-success">
                    <tr>
                        <th>ID</th>
                        <th>Item Name</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Total Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="order-table-body">
                    <!-- Order rows will be inserted here -->
                </tbody>
                <tfoot>
                    <tr>
                        <td><strong>Subtotal</strong></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td id="subtotal-value">$0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            <div class="text-center mt-4">
                <button class="btn btn-primary" id="checkout-btn">Proceed to Checkout</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
